{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tasks</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<section class="section">
    <div class="container">

        <div class="level">
            <div class="level-left">
                <div>
                    <h1 class="title">TikiTiki Agenda</h1>
                    <p class="subtitle is-6">
                        The best agenda... for the TikiTiki island.
                    </p>
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="button is-light is-small">
                            <span class="icon is-small">
                                <i class="fas fa-sign-out-alt"></i>
                            </span>
                            <span>Logout</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="box">
            <form method="get" class="columns is-multiline is-vcentered">

                <div class="column is-12-tablet is-4-desktop">
                    <div class="field">
                        <label class="label is-small">Search</label>
                        <div class="control has-icons-left">
                            <input class="input is-small" type="text" name="q"
                                   placeholder="Search by title or description"
                                   value="{{ request.GET.q|default_if_none:'' }}">
                            <span class="icon is-small is-left">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="column is-6 -tablet is-2-desktop">
                    <div class="field">
                        <label class="label is-small">Status</label>
                        <div class="control">
                            <div class="select is-small is-fullwidth">
                                <select name="status">
                                    <option value="">All</option>
                                    <option value="open" {% if request.GET.status == "open" %}selected{% endif %}>Not completed</option>
                                    <option value="completed" {% if request.GET.status == "completed" %}selected{% endif %}>Completed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column is-6-tablet is-2-desktop">
                    <div class="field">
                        <label class="label is-small">Min. Priority</label>
                        <div class="control">
                            <div class="select is-small is-fullwidth">
                                <select name="min_priority">
                                    <option value="">Any</option>
                                    {% for p in "12345" %}
                                        <option value="{{ p }}"
                                          {% if request.GET.min_priority == p %}selected{% endif %}>{{ p }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column is-6-tablet is-2-desktop">
                    <div class="field">
                        <label class="label is-small">Sort by</label>
                        <div class="control">
                            <div class="select is-small is-fullwidth">
                                <select name="order">
                                    <option value="">Default</option>
                                    <option value="date" {% if request.GET.order == "date" %}selected{% endif %}>Date (asc)</option>
                                    <option value="-date" {% if request.GET.order == "-date" %}selected{% endif %}>Date (desc)</option>
                                    <option value="priority" {% if request.GET.order == "priority" %}selected{% endif %}>Priority (low → high)</option>
                                    <option value="-priority" {% if request.GET.order == "-priority" %}selected{% endif %}>Priority (high → low)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column is-12-tablet is-4-desktop has-text-right">
                    <div class="field is-grouped is-grouped-right is-grouped-multiline">
                        <p class="control">
                            <button type="submit" class="button is-link is-small">
                                <span class="icon is-small">
                                    <i class="fas fa-filter"></i>
                                </span>
                                <span>Apply</span>
                            </button>
                        </p>
                        <p class="control">
                            <a href="{% url 'index' %}" class="button is-light is-small">
                                <span class="icon is-small">
                                    <i class="fas fa-rotate-left"></i>
                                </span>
                                <span>Reset</span>
                            </a>
                        </p>
                        <p class="control">
                            <a href="{% url 'task_create' %}" class="button is-primary is-small">
                                <span class="icon is-small"><i class="fas fa-plus"></i></span>
                                <span>New Task</span>
                            </a>
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <div class="columns">

            <div class="column is-9">
                {% if tasks %}
                    {% for task in tasks %}
                        <article class="box {% if task.completed %}has-background-light{% endif %}">
                            <div class="level">
                                <div class="level-left">
                                    <div>
                                        <p class="title is-5">
                                            {% if task.completed %}
                                                <span class="icon has-text-success">
                                                    <i class="fas fa-check-circle"></i>
                                                </span>
                                            {% else %}
                                                <span class="icon has-text-warning">
                                                    <i class="far fa-circle"></i>
                                                </span>
                                            {% endif %}

                                            {{ task.title }}
                                        </p>

                                        {% if task.description %}
                                            <p class="content is-small">
                                                {{ task.description|truncatechars:180 }}
                                            </p>
                                        {% endif %}

                                        {% if task.tags.all %}
                                            <div class="tags">
                                                {% for tag in task.tags.all %}
                                                    <span class="tag is-info is-light is-rounded">
                                                        {{ tag.name }}
                                                    </span>
                                                {% empty %}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="level-right">
                                    <div class="has-text-right">

                                        <p class="is-size-7 has-text-grey">
                                            {% if task.date %}
                                                <span class="icon is-small">
                                                    <i class="far fa-calendar-alt"></i>
                                                </span>
                                                {{ task.date }}
                                            {% else %}
                                                <span class="tag is-light is-warning is-rounded is-size-7">
                                                    No date
                                                </span>
                                            {% endif %}
                                        </p>

                                        <p class="mt-2">
                                            
                                            {% with task.priority|default:3 as pr %}
                                            
                                                <span class="tag {{ task.priority_color }} is-light is-rounded is-size-7">
                                                    Priority: {{ pr }}
                                                </span>
                                    
                                            {% endwith %}

                                        </p>

                                        
                                        <div class="buttons is-right mt-3">
                                            <form method="post" action="{% url 'task_delete' task.pk %}" style="display:inline;"
                                            onsubmit="return confirm('Are you sure you want to delete this task?');">
                                                {% csrf_token %}
                                                <button type="submit" class="button is-small is-danger is-light">
                                                    <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                                </button>
                                            </form>
                                            <a href="{% url 'task_update' task.pk %}" class="button is-small is-info is-light">
                                                <span class="icon is-small"><i class="fas fa-pen"></i></span>
                                            </a>
                                            <form method="post" action="{% url 'task_toggle_completed' task.pk %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="button is-small {% if task.completed %}is-warning{% else %}is-success{% endif %}">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-check"></i>
                                                    </span>
                                                    <span>{% if task.completed %}Mark as pending{% else %}Mark as done{% endif %}</span>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                {% else %}
                    <div class="notification is-light">
                        No tasks found. Try changing the filters or create a new task.
                    </div>
                {% endif %}
            </div>

            <div class="column is-3">

                <div class="box">
                    <p class="title is-6">Overview</p>
                    <p class="is-size-7">Completed tasks: <strong>{{ completed_tasks }} / {{ total_tasks }}</strong></p>
                    <progress class="progress is-small is-info" value="{{ percentage }}" max="100">
                    </progress>
                </div>
            </div>
        </div>
    </div>
</section>
</body>
</html>
{% endblock %}
